---
layout: post
title: Blockchain－Merkle Patricia Tree详解
date: 2018-03-30
author: lyton
tags: Merkle Patricia Tree
---
### Merkle Patricia Tree简介
Merkle Patricia Tree是一种经过改良的数据结构，其融合了默克尔树和前缀树两种树的结构优点，在以太坊中用来组织管理账户数据、生成交易集合哈希的重要数据。
MPT树具有一下几个作用：
* 存储任意长度的Key－value键值对数据；
* 提供一种快速计算所维护数据集哈希标识的机制；
* 提供快速状态回滚的机制；
* 提供一种称为默克尔证明的证明方法，进行轻节点扩展，实现简单支付验证；

### 默克尔树
Merkle树是由计算机科学家Ralph Merkle在很多年前提出并由此命名，在比特币的网络中通过Merkle验证数据的正确性。在比特币的网络中，Merkle被用来归纳一个区块中的交易，同时生成整个交易集合的数字指纹。由于Merkle的存在，将比特币这种公链的产物，扩展为轻节点，使支付验证更加简单。
###### 原理
在比特币网络中，merkle从下向上构建。在如下的例子中，首先将L1-L4四个单元数据哈希化，然后将哈希值存储到相应的叶子节点中，这些节点是Hash0－0，Hash0-1，Hash1-0，Hash1-1，通过合并相邻的两个哈希值，形成新的字符串，重复此步骤到根节点。
![avatar](/assets/img/merklepatriciatree/merkletheory.png)
具体根节点的计算可参考以太坊Merkle博客，上图中的一颗有着四个叶子节点的树，计算代表整个树的哈希需要7次计算，如果采用将这四个节点拼接到一起，只需要计算一次hash。但是为什么使用Merkle？

###### 特点
* Merkle是一种树结构，可以是二叉树、多叉树，无论几叉树，都具有数结构的特点。
* Merkle树叶子节点的value是数据项的内容，或者是数据项的哈希值
* 非叶子节点的value是根据孩子的信息，通过hash算法计算得出

###### 优势
* 快速重哈希 <br>

当Merkle节点发生变化的时候，只需要在当前发生变化的节点上计算，把跟发生变化的节点相关的节点再计算一次，便能得到新的根节点哈希值。

###### 劣势
* 轻节点扩展<br>

采用Merkle，只需存储区块头数据，不需要存储整个交易列表，回值列表等数据。

### 前缀树
前缀树（又称为字典树），用于保存关联数组，其键（key）的内容通常为字符串。前缀树节点在树中的位置是由其键的内容所决定的，即前缀树的key值被编码在根节点到该节点的路径中。如图所示：图中有六个叶子节点，其key值分别为to,tea,ted,ten,inn,A
<div align=center>
![avatar](/assets/img/merklepatriciatree/dictionarytree.png)
</div>
###### 优势
相对于哈希表，使用前缀树来进行查询拥有共同前缀key的数据时十分高效，例如在字典中查找前缀为pre的单词，对于哈希表而言，需要遍历整个表，时间效率为O(n)；对于前缀树，只需要在树中找到pre的几点，且遍历这个根节点的子树即可。相对于前缀树，不存在哈西冲突问题。

###### 劣势
* 直接查找效率低下<br>

前缀树查找效率为O(m)，m为所查节电的key长度，而哈希表的查找效率为O(1)。且一次查找会有M次IO开销，相比于直接查找，无论速度还是对磁盘的压力都比较大。
* 可能会造成空间浪费

当存在一个节点，其key值的内容比较长，当树中没有与之对应的前缀分支时，为了存储该节点，需要创建许多非叶子节点来存储路径，造成存储空间浪费。

### MPT结构设计
